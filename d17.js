const input = `123143232522132362565522552366665466444444354354765573477364677553744554544367373475353674435736776364364225646566345432455654256253553441544\n513554112134545522424636644264364636423433734634574764734674335773453337467475335776347476447443456553366343436536344433322355656411245352352\n334132411532364365225542263426336654323554453566537436754563453756534455435556373777356773767445744365753523332263433566233526636225333232555\n341223414232233322244334453225423235453535467444774364576474666443637644447334656337367647536767347665647722454562236334622462526532224554113\n215343144656422326322563632225254465556673677434733476346766774433675633335653457775633744455337667735437754532435256566345526254522523432513\n531522235224332356225564244256645357353563766554375447737774333736636743354367366463643467455453765556744466332363636343265522424524536333235\n212421462652356556432642564536626435646437465437576437636635743455373445563777734744465576766374365733673776555563656346653644636453546343255\n423123235254552242326466625643534774755356775755337636444437344334374634756655457764573533564533345367676567753436432526334425236236454263525\n254346522562326652524642646443446346777455654465765355455574365537546376354566455435565543346776743356655376355743626232244442423433462263144\n131563556352364324236426466476453766375667746755765535735463747437467574353457477475535476557354643344676545775457474625533424565564322646425\n242344435642542245466333334537333655373345664436737743455345376763757355737736353754344334645555754437335566477457657245533342454463346453322\n424623432335543435435655363574573375335744564556647444437653885485647874464486464653546777574544536746666764646353734542442345434556635625245\n554436643554335325233653537644666345344637363633535547576468768755485765566866658677875664445744744765355436337653355334652633666654253625445\n424236626242463266666445564765645433767745635765367565746766646674476677556466648756555845367546534375475373774566335376352324554654635422242\n234442455443342245553665555356654774463754343373544874574776858858855646555454467667766745875643757363337356353764473476662533365233645253354\n564465353545656643633536546466765364673753344356656588677876788458456786665775557884554587644684763644677763777374454435534422652236555625355\n246642462566353323463575567476673567373353637467568876478765776678757767644648444446874565558448663343375564547536344753575532424366352252455\n446442435655646522453476334377546555737337447688674765784847476575864466456844675748785446676768676576675477476665766465773763343433422424455\n642522452643426257675367345763656337673667755665764847777677765568587887544574748666654547887456648545535655647554435566333447236435665624653\n542432253455644354733376755577435473677748878658657656854585646845546545847486866446744856845856485454634456546743734546573633546443332543564\n533566253433224746667673465773656744738645657465658776567548777877477444748664647546478654785858585477445777777445745336654637336525653262255\n535664336523624476776564674556543776768857874647754886685544658656668677484476578785774776858477468787588637446734554477763656645323536343422\n532665655644274435445767654336667534578686466564455748875455877754478646885675747747678774655466647564857665556576365567476344554563636332225\n366233346635447665565437737776767747657655647456844857465575477846765456486844758556886667845644768676786844444747755375474757774465526342352\n243663253344676673647353636546666668768665655855577587666884676887577864675667757554855844778467765754847477566466465735364744746547235452266\n466562626537467676663343457554386747774648854488684475768884578668865766447465784767654744757757477764686645858845445664577635653664435423644\n335665444347357375634657374346655778554574646558855866588587568867966697579985668467487565686866678854888657684844357537364354366345765226323\n636656354736453737536357653644878745667877474558548586775467958775995755887766588667644784746446874755776846576545353757535436374637445562555\n524526236763676774564767643577557886465456655458545687549775766976675668585679699558678656884778887856474545888487463347757765365733445255325\n224532565663535675346474354746846787466564688457546446689757555677576657875897669856585786644854685646567786656675843757377643453753736243333\n646436267446563476744655546745487786648674656555764996886579757698788866759596556798669798877775878564455585554444786535547647436574575753343\n325565243656354764566453786455756444867876785775869587987977995969777858866659969695698955695676874686777757467456468677464736443637554366534\n556465556673456665647353766557674746468758686485657956676969696566667878956799656796558756958856646576556486845584475433563774443656676442463\n644365475765446435545376467447776488477576887876565975758586575958997765699877597675866567557975945864548648448587486855776677334556373344644\n645253467436477673557536755854757868656668488575955978686995977858965877975579979588865757659897568586777584585865887577755663667333757553242\n435354644634775763464667766647776758478578597798556785679989795988656878688897978789868857995988978764864685744465884744766363365734756647526\n236443563446637473555687468867486878566656979779796979857896668959576889579595876679568668978677889576588585766775474758457776747647434763544\n223557347555533366474687458676466577444468888985889667596668899899889878555876989988976966786955575976846876558686767878565345545633434547444\n345464666575656757346745488875864585748885857869555777665558765887569886997876668578795768657799967957756554546555578855566466654644743733364\n224477635454537365676446774888868686766977766759975988898956965755855589995698888966569586879888585686997557565686587756678445434645754765546\n536675635435677643444467485865756776877698869896669786787756695795658997899996985598578555655968698568769868848578488464655774455637477344777\n634736656435343457786855786847654668657556876597669567768885875695899787987976589778897555558659978958956866474584446478777746765336753547374\n655335455453344536466447548856578487795856675598697669958569669689887866986697969598876778997879866856768598868647745564885757355677363636766\n435474455354463547465666476564646557596857769987659796597989976767997987976667787798678998795556699576695967744557886786464867375336667644776\n336744444554374368577568455776887766569956798697599668555789687797967896967889787768686965798598699785559655766755466888455687675344474446667\n464355746733557747478587877758747578975568676788876956957867886687776899997889968989796865656888796985598777586576874758684664873775764644535\n546434665567577567668447466577645866859777566888569995877768876896886866887677669866699685759568889878996857665478775466745778756564666777734\n577556637574353866474655886466488688555566986656995769997876876796976787877777967878887998589856886786559686765487646668568544746336663367365\n764467765543455774868664674884767556679569965679669799876879668968678986998798776999668788869755855695786578596854468785887587665556677764677\n675674775533467576656854778587757697989686595576677897767676798998799689878896699788988889876885655599658877659654565556464845743643647454657\n464355335773576856486884576786586785669959956865769869997767798867866886698989766977697686989796589796897565687957864744675645888467433766363\n357466766476366456884874777574567786977879765695889766998789966996976697888979787668869786979996696955679586996887567685884847775534544775375\n555647566474678656544574556448679666858965775676798879687866687996667999687887996896699679897666896656879598589576485847545764844757334736756\n467533464375678548444554874886665767889966867658896866686787799697899897986868979687779799979676977966968869658986578856464688486746365474536\n666443356745375584645568846467698875877895687997677876869877799866666768787796986996787998799886997578996985656958444884688655754537353633733\n575753773376574568775877765585985658877977786878879686969699779777899896799877789768689669899686797958585988697585764454884587888467665557666\n537344544753477466848646867459659985859766668766788796686698866977777999999779667796889787869898665668567869955789878485686758445886336373375\n434375643576748864555675847865657895758698976897889898977796797679798898987878677686688686888688988665797668687868854445758476856446573556755\n765734633566855774447544878579955859878595557769786899669899898678998797977877976869986666899789976656895796687885648777555445868887364556776\n575547657573664758648877756858695877959998766767778879876998887877888798798997977799687968867968686869658667986979758788855456774444647654643\n544356664454756765887644445695896677567796986878877696898679689777788778799888889786977898876999668977689889579786676746576885644465337635766\n653554366554747646668767588796796899975668887677677679868999979877999977787899979787878769968699697958688976697878567688657876855546534477547\n357453443734546844675748775976676995757665967888887966978988877779888777897787797989678786678977688797756795857879697457848667867646533664655\n776334634577545656568476867896555585658766986688769666677879798988887788788979879798767699989689977866999768956859676877768585577577556465645\n643655363466478875574568847898695688658787867676666778867879999978989778898797798897789887967666976689557898598688689645875857474657556545373\n757436346477475477645485656978865788869656867889767686896989978888779778897998999989777786897886678777898999566886768766757566544668554454674\n653337674454876856878888468778968995985877876769697678778989879798799798877878788997989997977686879966966986795995777687485777445778563543635\n457347476535446458854757447988757988978997786787766989869979977999979979898888799887797968888896998787796999877765989754488457778886447364477\n334547743667778544667464765567688656599679898888669978677788788788879979999887798777888797777696689768586889678986595876685668684785656677664\n374775447564765746577548785566655556679877776797886986788997879887979778779878997777798777967788996779576575676987589674785678444776654666474\n537365567465786446464774768955877897565567968696696986999898789889788899787987987998889797877978896697886899556856958887784655548764877665433\n366354653765664657857578775567898559575889997989776867869997879997789789987979999888889976989767877999865887568897995474678448864467633547357\n664346577755766747686747466568897859969859687779766766799888878979898878877799878979889967889768968967965979859676887654767586774858476667773\n364646753456457677484784469586666696686778696967768796997789788998797799777778987779898679796968996996755586577786987665587765578585553576757\n466746336364775568644847747996789766985779698776896689897789789787877989797898798787988697686767978679587787998888698458857686847486675735645\n454656653367888875465644777657976867875858998989967986979777789977898877877888789887978996786966867699896677879798759786546566775486434534373\n644753356477864746758586675558887995657677699887887976977798778798878797788898878878796789689999676677975689868669558647745564648878573745476\n363574337736654488646757669556697789795899986768878967867897799887789797877887888777977977766978976878987895567578577764648667758775334363675\n675574473775886664477785589597988957575886787998976669877997887977779987778999898889876987869867887775657578976969987787544544774864765574676\n563364457636686454785476867567699687658579679986989788868678787788889878798787877788878797866666977897576885668985559576684875588785556776676\n675475466745564585854586557976896559758895697896887688997678979997798977997788898979869876799898768969579878588986588758677748475788733437454\n634646354636777868875668784559769769585655898887999877678987787888997797987898987896698787686769998679585675575657675545446555567566543337565\n657533773365674487847544576587688896589965597797999689767799799888898889987988977867887697768966677679568598559557694566844446477787557543753\n354353673355775645675678454959668785787885999876697887877787779987979878999788998988877977967679977969975966796966678544776665447783337566363\n544767457644748688468484547495895666759657656977877877987699769897878897798777779696976867998878989699699965766865985677464786454475757643753\n764755677544667766557466754458858687558777999788668667776668978878878888877778986697976798899986776669598767696695584484675888877743533633374\n555434665435654458854564874496659588789569755796978988669669866869686888987669776796689899687866675969676895588876754754488675675473465455363\n564537374365484445774775468867755999779989598969966799997768867886896766677689876786878786678986796855765688799799587885568845756536377474463\n657334756766785576868877677685896895989787766676767796879968787679789687889797976788696997876699778786788855558955688568865844684634373564635\n573665375546465858684886677477797766569998669599798769979777699666689779777998688789687769978996769879869977895699447546556554578846445735436\n443343357565565648548865567488956665675665997767897977778969999896797889688886999968969887686887555869587998859578787454885546864555475366676\n634474575465635445648848475554577958686798965985967987799789898667776986889988878997966688899876789776586987855678886455468467676635736755636\n464444446646376846477557556584565967987986596668868786667769698966779877686798787979988796976799789666995779875955664475788765566657664375346\n477333473765376546866658545656588769977689678595777779696676968789688797889996679777986886866768757976889785677854454546744567553773644576766\n743445343377675484745448667888868877758695585856989787697878986899798866898879966896677978866888857765796769698688556874584767483743646557675\n463536736366635666475754768546457758697697775658795969696787666688778966688876867877766986689796886566779669665564447857485485687557375373544\n535746676565734474684487775776857656977977786695857998786897767696868898896896976679669776585767789596798656774884756567454458847333365437553\n535766467334657364587786677764767767869788769699999979558986688999779699986668678799996885868957675869968968684646874746778674844477547363377\n547745464657455775584775674654554785778798975888879979865696669966968668969668676887789965757795577975558687685848564458477767336564565463334\n377766676735375448455444675465446476598987895786769568868977687678876969678669899896966976899599786578598587877847847546565667373573773665743\n353737675635354633544778764774755585775778656666599686789977759898686786789869688986799755966575788956875885747585446584474677473436477754765\n457444337673347567767846864455765585696656956668698559859866888969997798796877968559666695667566579966657648568886654885468566536356375563737\n237637737775774537557557486668487746465966877577789966658667667867577779966969996855689586998557568956587654566545868447667764453455636735445\n664573534374543453776548567674684667457876977789897566969656959769756779955587897797656667759595665757998444564776864866544764753434674774653\n465434747335645736344588767568458645768658786755798699576968787968676767788879776995795995566785889955978465876876586656777776447567537333452\n242477446667634737654767875548767866457886665779867889589695985858886596759587756766995966566657765976488755866575564867676673677533437444466\n436573643344744453775374566575466455666548667659975876867598796685957679886958578785759755889799855794675767455665668875654565737644747764653\n364653345655334574355355486686557746857586796598667855997789689589659689798775578786785778996785968968574566688775876446863373434657536336722\n432224353535466545676346847464474684887654845856596875766667866896557668587685678659698765676687694874888555474578657554564755337655736566425\n466227343334436443543565686885785867745856467756587795659787757775766765958755766858768858789669966865858668475464658557763633575774375763564\n525564345744353535555567785567757545886887877886757559675685855967669987576888565685885885757665685586465887587456646573346554334466735664223\n322454443667644657466557545645764746786748468465555766997968786685999777878859877666868955797657458644667458875757555575563765656665563744423\n526235554376335666336344466877478786845478668888848866879599958776678658899688756675589678968764877478747774888868565357767455474747666443242\n344622625445755754663736444486456848574777557765744877889959576589877597556985968796558567686855454588885546545445545334436365757556635256645\n222455464466463646535754446765768747674867876647556488676657757889995657595979795666655775558784876677788647744774473755454643364575576552266\n243524626535645656667754347734464886885548747788856647886577967889856975567759587597874745864785668558758486686868334754654635765654765566323\n524245646536573434557365534456854854446448447657875866878686665858596665668987587747654584884774744786467586886864634544567676666775765533443\n655653456234744577677375445656784768584857778566776875458778767477456655748474456544658768744667745888787774664877354643566436634667432533634\n423632226433677377477334757546653486644876847678764857846575768577587557684556848558585758454885756646767685573467433575674365453654242543522\n352453666322373443653643544474457776748744755567574844555676554486754867488555755474464544578564478745487747745764456743563443333334443563445\n522625526632547736434543367557657778764574766885656848488545656844445776467858787558546768655675756886847474743656664646733557637464342446332\n225465653225326764555556636363474544454888665465766776478568756767645886586757678685554576678485657468767834445777653766636654347522266665663\n466533445366426566654363356546345565355665786784747784647446685664864467465475776866847565548768676654878563757755547656433364353566434523343\n535344665534355473346676753444444344554454658888484564878487478665446566866774875887547875675664787578474567333355567336363334532556325343445\n534665425565233537643736375646455637454668486444787555866455444588744548767878846777687857647455576647657666373464677364567657646224433234442\n552363644633464646533755334537576446547554765466476545456766457567748858786667865467675888444454658437344643437565657746673474242455336334452\n654365255623562655465745753553437574354463365556666878584748554788547855858865865888656787646585855735773675445673674566544645265465643462655\n543422325625426423426555477774575374437775673745757555787586845784768844447586686867756466844445736557635765457364567436677252642322445355532\n246544563266333334544353464754575666676676377536736647787776577886784644546478558464765644475664663474747647553636334334335233265455643425353\n554365425345425453436567443677534644465457366474766557478746757567775446674756588666766564457556565734446544676353633346735622245664422643256\n326642456644426236642444754576366776567463337676475367647846747677456767865645787884448367364745773455334654334573335347543622454464666652464\n343465234234554632656442655545546645554556466534655634677534858564878888654845854764743476563665366443755773564343465536363435556263562632324\n332354642234543464356334424463334656467434334363566674447373375363356766533645566353777575344774453377435344577353564236536562364222625566452\n511253623333566426644236326675745564475664657573356446435475336366346437456335767355744564745655766357753353374676772362362446436425453452244\n444556335353542342235665243444456563655677574633463543366576467763543346747376754576734466553657463535773777343653444655626443565553636445415\n322514556323234322626646226545544354343745777475554754453644357357745757735534365644437756773776477636357765673363523364434455526534533333331\n143551153364623263526524353352435365467546445636757453634474677633575455733443765544444576337677733566373663477345233643566524322226565454334\n524523513326646252552334624363523666537764777573475556434547544565643343753754735473337474444747563445535675534553433623464465625454353133423\n524345215236452635534644535645353663745354663437465355646747334673655636566744464557645556465643553353756734566642645443422243322236651343245\n421251533446326563335532353656352523276577565657664636377567467637453775654666633467544776363776576357347366362625243455353562555654212325112\n424113122324552346435655266243442633224765636377545477665646434644455357573434437537656637355574635654562464445523566246426643522255552445212`;

function inputToMatrix(input) {
  const data = input.split('\n');
  const rows = data.length;
  const cols = data[0].length;
  const matrix = Array.from({length: rows}, () => Array(cols));
  for (let row = 0; row < rows; row++) {
    for (let col = 0; col < cols; col++) {
      matrix[row][col] = {row, col, cost: parseInt(data[row][col])}
    }
  }
  return {rows, cols, matrix};
}

// https://stackoverflow.com/a/66511107/4235871
const MinHeap={siftDown(h,i=0,v=h[i]){if(i<h.length){let k=v[0];while(1){let j=i*2+1;if(j+1<h.length&&h[j][0]>h[j+1][0])j++;if(j>=h.length||k<=h[j][0])break;h[i]=h[j];i=j;}h[i]=v}},heapify(h){for(let i=h.length>>1;i--;)this.siftDown(h,i);return h},pop(h){return this.exchange(h,h.pop())},exchange(h,v){if(!h.length)return v;let w=h[0];this.siftDown(h,0,v);return w},push(h,v){let k=v[0],i=h.length,j;while((j=(i-1)>>1)>=0&&k<h[j][0]){h[i]=h[j];i=j}h[i]=v;return h}};

// part 1
const UP = 0;
const RIGHT = 1;
const DOWN = 2;
const LEFT = 3;

const {rows, cols, matrix} = inputToMatrix(input);

function isValidRowCol(row, col) {
  return row >= 0 && row < rows && col >= 0 && col < cols;
}

function key({row, col}, dir, sameDirCount) {
  return `${row},${col},${dir},${sameDirCount}`;
}

function getDirBetween(cell1, cell2) {
  if (cell1.row === cell2.row) {
    return cell1.col < cell2.col ? RIGHT : LEFT;
  }
  if (cell1.row < cell2.row) return DOWN;
  return UP;
}

function getDestinations(cur, part2 = false, finalDest) {
  // get von Neaumann neighborhood
  const destinations = [
    {row: cur.cell.row - 1, col: cur.cell.col},
    {row: cur.cell.row, col: cur.cell.col + 1},
    {row: cur.cell.row + 1, col: cur.cell.col},
    {row: cur.cell.row, col: cur.cell.col - 1},
  ].filter(({row, col}) => isValidRowCol(row, col));
  let cells = destinations.map(dest => matrix[dest.row][dest.col]);
  // can't go back
  cells = cells.filter(dest => (getDirBetween(cur.cell, dest)+2) % 4 != cur.dir);
  // can't go straight if already went straight 3 times
  if (!part2 && cur.sameDirCount >= 3) {
    cells = cells.filter(dest => getDirBetween(cur.cell, dest) !== cur.dir);
  }
  if (part2) {
    if (cur.sameDirCount < 4) {
      cells = cells.filter(dest => getDirBetween(cur.cell, dest) === cur.dir);
    } else if (cur.sameDirCount >= 10) {
      cells = cells.filter(dest => getDirBetween(cur.cell, dest) !== cur.dir);
    }
  }

  return cells;
}

// Uniform Cost Search
function dijkstra(start, dest, part2 = false) {
  const costSoFar = new Map();
  const cameFrom = new Map();
  const frontier = [];
  MinHeap.push(frontier, [0, {cell: start, dir: RIGHT, sameDirCount: 0}]);
  MinHeap.push(frontier, [0, {cell: start, dir: DOWN, sameDirCount: 0}]);
  cameFrom.set(key(start, DOWN, 0), null);
  cameFrom.set(key(start, RIGHT, 0), null);
  costSoFar.set(key(start, DOWN, 0), 0);
  costSoFar.set(key(start, RIGHT, 0), 0);

  const possibleCosts = [];
  while (frontier.length > 0) {
    const [_, cur] = MinHeap.pop(frontier);
    if (cur.cell === dest && (!part2 || cur.sameDirCount >= 4)) {
      const finalCost = costSoFar.get(key(cur.cell, cur.dir, cur.sameDirCount));
      possibleCosts.push(finalCost);
    };
    const curKey = key(cur.cell, cur.dir, cur.sameDirCount);
    const destinations = getDestinations(cur, part2, dest);
    for (const dest of destinations) {
      const dir = getDirBetween(cur.cell, dest);
      const sameDirCount = dir === cur.dir ? cur.sameDirCount + 1 : 1;
      const newCost = costSoFar.get(curKey) + dest.cost;
      const destKey = key(dest, dir, sameDirCount);
      if (costSoFar.has(destKey)) continue;
      costSoFar.set(destKey, newCost);
      cameFrom.set(destKey, cur);
      MinHeap.push(frontier, [newCost, {cell: dest, dir, sameDirCount}]);
    }
  }

  return Math.min(...possibleCosts);
}

const start = matrix[0][0];
const dest = matrix[rows - 1][cols - 1];
console.log(dijkstra(start, dest));

// part 2
console.log(dijkstra(start, dest, true));